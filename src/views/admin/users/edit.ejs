<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Edit User | Admin Dashboard</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="/assets/css/common.css" />
    <link rel="stylesheet" href="/assets/css/form.css" />
  </head>

  <!-- Main Content -->
  <div class="content-header">
    <h1>Edit User</h1>
    <div style="display: flex">
      <a href="/admin/users" class="btn btn-secondary">
        <i class="fas fa-arrow-left"></i> Back to Users
      </a>
      <form
        id="deleteForm"
        method="POST"
        action="/admin/users/<%= user.id %>/force-delete?_method=DELETE"
      >
        <button
          type="submit"
          class="btn btn-danger"
          id="deleteUserBtn"
          style="margin-left: 10px"
        >
          <i class="fas fa-trash"></i>
          Delete User
        </button>
      </form>
    </div>
  </div>

  <!-- Success Message -->
  <div
    id="successMessage"
    class="message message-success"
    style="display: none"
  >
    <i class="fas fa-check-circle"></i>
    <span data-message-text>User has been updated successfully.</span>
  </div>

  <!-- Edit User Form -->
  <form
    id="editUserForm"
    class="card"
    method="POST"
    action="/admin/users/<%= user.id %>?_method=PUT"
    enctype="multipart/form-data"
  >
    <div class="card-header">
      <h3>User Information</h3>
    </div>
    <div class="card-body">
      <div class="form-section">
        <h3>Personal Information</h3>
        <div class="form-group <%= errors?.name ? 'invalid' : '' %>">
          <label for="userName">Full Name*</label>
          <input
            autocomplete="name"
            type="text"
            id="userName"
            name="name"
            class="form-control"
          />
          <% if (errors?.name) { %>
          <span class="form-message" id="userNameError">
            <%= errors?.name %>
          </span>
          <% } %>
          <div class="form-group">
            <label
              style="margin-top: 10px; max-width: fit-content"
              for="userAvatar"
            >
              Avatar
              <div
                class="avatar"
                style="width: 100px; height: 100px; margin-top: 20px"
              >
                <img
                  src="<%= user.avatar %>"
                  alt=""
                  class="avatarImg avatar"
                  style="width: 100%; height: 100%; margin: 0"
                />
              </div>
            </label>
          </div>
          <input
            hidden
            type="file"
            id="userAvatar"
            name="avatar"
            class="form-control"
          />
        </div>

        <div class="form-row">
          <div class="form-group <%= errors?.email ? 'invalid' : '' %>">
            <label for="userEmail">Email*</label>
            <input
              type="email"
              id="userEmail"
              name="email"
              class="form-control"
            />
            <% if (errors?.email) {%>
            <span class="form-message" id="userEmailError">
              <%= errors?.email %>
            </span>
            <% } %>
          </div>

          <div class="form-group <%= errors?.phone ? 'invalid' : '' %>">
            <label for="userPhone">Phone</label>
            <input
              type="tel"
              id="userPhone"
              name="phone"
              class="form-control"
            />
            <% if (errors?.phone) { %>
            <span class="form-message" id="userPhoneError">
              <%= errors?.phone %>
            </span>
            <% } %>
          </div>
        </div>

        <div class="form-group">
          <label for="userAddress">Address</label>
          <textarea
            id="userAddress"
            name="address"
            class="form-control"
            rows="2"
          ></textarea>
          <% if (errors?.address) { %>
          <span class="custom-error-text" id="userAddressError">
            <%= errors?.address %>
          </span>
          <% } %>
        </div>
      </div>

      <div class="form-section">
        <h3>Account Information</h3>
        <div class="form-group">
          <label for="userUsername">Username*</label>
          <input
            type="text"
            id="userUsername"
            name="username"
            class="form-control"
          />
          <% if (errors?.username) {%>
          <span class="custom-error-text" id="userUsernameError">
            <%= errors?.username %>
          </span>
          <% } %>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="userRole">Role*</label>
            <% const roles = ['Admin', 'Editor', 'Viewer'] %>
            <select id="userRole" name="role" class="form-control">
              <option value="">Select Role</option>

              <% for (role of roles) { %>
              <% const selected = user?.role === role ? 'selected' : '' %>
              <option value="<%= role %>"><%= role%></option>
              <% } %>
            </select>
            <span class="error-text" id="userRoleError"></span>
          </div>

          <div class="form-group">
            <label for="userStatus">Status*</label>
            <% const statuses = ['Active', 'Inactive', 'Pending'] %>
            <select id="userStatus" name="status" class="form-control">
              <option value="">Select Status</option>
              <% for (status of statuses) { %>
              <option value="<%= status %>"><%= status%></option>
              <% } %>
            </select>
            <span class="error-text" id="userStatusError"></span>
          </div>
        </div>

        <div class="form-group">
          <label for="dateCreated">Date Created</label>
          <input
            type="text"
            id="dateCreated"
            class="form-control"
            readonly
            disabled
          />
        </div>

        <div class="form-group">
          <label for="lastLogin">Last Login</label>
          <input
            type="text"
            id="lastLogin"
            class="form-control"
            readonly
            disabled
          />
        </div>
      </div>

      <div class="form-section">
        <h3>Change Password</h3>
        <p class="form-help-text">Leave blank to keep the current password</p>
        <div class="form-row">
          <div class="form-group">
            <label for="userPassword">New Password</label>
            <input
              type="password"
              id="userPassword"
              name="password"
              class="form-control"
              data-validate="password"
            />
            <span class="error-text" id="userPasswordError"></span>
          </div>

          <div class="form-group">
            <label for="userConfirmPassword">Confirm New Password</label>
            <input
              type="password"
              id="userConfirmPassword"
              name="confirm_password"
              class="form-control"
            />
            <span class="error-text" id="userConfirmPasswordError"></span>
          </div>
        </div>
        <p class="form-help-text">
          Password must be at least 8 characters and include uppercase,
          lowercase, number, and special character.
        </p>
      </div>

      <div class="form-buttons">
        <button type="button" class="btn btn-secondary" id="cancelBtn">
          Cancel
        </button>
        <button type="submit" class="btn btn-primary">
          <i class="fas fa-save"></i> Save Changes
        </button>
      </div>
    </div>
  </form>

  <!-- Confirm Delete Modal -->
  <div class="modal" id="confirmDeleteModal">
    <div class="modal-content">
      <h3 class="modal-title">Confirm Delete</h3>
      <div class="modal-body">
        Are you sure you want to delete user "<span id="deleteUserName"></span
        >"? This action cannot be undone.
      </div>
      <div class="modal-footer">
        <button
          type="button"
          id="cancelDelete"
          class="btn btn-secondary"
          data-cancel
        >
          Cancel
        </button>
        <button
          type="submit"
          id="confirmDelete"
          class="btn btn-danger"
          data-confirm
        >
          Delete
        </button>
      </div>
    </div>
  </div>

  <script src="assets/js/common.js"></script>

  <script>
    const userAvatarInput = document.getElementById("userAvatar");
    const avatarImg = document.querySelector(".avatarImg");
    userAvatarInput.addEventListener("change", () => {
      const file = userAvatarInput.files[0];
      if (file) {
        avatarImg.src = URL.createObjectURL(file);
      }
    });
    document.addEventListener("DOMContentLoaded", function () {
      // Initialize form validation
      initFormValidation("editUserForm");

      // Load user data
      loadUserData();

      // Handle form submission
      document
        .getElementById("editUserForm")
        .addEventListener("submit", function (event) {
          event.preventDefault();

          if (validateForm("editUserForm")) {
            // Check if password and confirm password match (if provided)
            const password = document.getElementById("userPassword").value;
            const confirmPassword = document.getElementById(
              "userConfirmPassword",
            ).value;

            if (password && password !== confirmPassword) {
              showError(
                document.getElementById("userConfirmPassword"),
                "Passwords do not match.",
              );
              return;
            } else if (!password && confirmPassword) {
              showError(
                document.getElementById("userPassword"),
                "Please fill the password first",
              );
              return;
            }
            this.submit();
          }
        });

      // Handle cancel button
      document
        .getElementById("cancelBtn")
        .addEventListener("click", function () {
          window.location.href = "/admin/users/<%= user.id%>";
        });

      // Handle delete button
      document
        .getElementById("deleteForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          // Get user name from field
          const userName = document.getElementById("userName").value;

          // Set the name in the modal
          document.getElementById("deleteUserName").textContent = userName;

          // Show modal
          const result = await showConfirmDialog("confirmDeleteModal");

          if (result) {
            this.submit();
          }
        });

      // Custom validation for password confirmation
      document
        .getElementById("userConfirmPassword")
        .addEventListener("blur", function () {
          const password = document.getElementById("userPassword").value;
          const confirmPassword = this.value;

          if (password && password !== confirmPassword) {
            showError(this, "Passwords do not match.");
          }
        });
    });

    // Load user data for editing
    function loadUserData() {
      // Set document title
      document.title = `Edit User: <%= user.name %> | Admin Dashboard`;

      // Fill form fields with user data
      document.getElementById("userName").value =
        "<%= old?.name || user.name %>";
      document.getElementById("userEmail").value =
        "<%= old?.email || user.email %>";
      document.getElementById("userPhone").value =
        "<%= old?.phone || user.phone %>";
      document.getElementById("userAddress").value =
        "<%= old?.address || user.address %>";
      document.getElementById("userUsername").value =
        "<%= old?.username || user.username %>";
      document.getElementById("userRole").value =
        "<%= old?.role || user.role || 'Administrator' %>";
      document.getElementById("userStatus").value =
        "<%= old?.status || user.status || 'Active' %>";
      document.getElementById("dateCreated").value =
        "<%= formatDate(user.created_at) %>";
      document.getElementById("lastLogin").value =
        "<%= formatDay(user.updated_at) %>";
    }
  </script>

  <style>
    .checkbox-group {
      margin-bottom: 10px;
    }

    .checkbox-group input[type="checkbox"] {
      margin-right: 8px;
    }

    .form-help-text {
      margin-top: 5px;
      color: #666;
      font-size: 13px;
    }
  </style>
</html>
